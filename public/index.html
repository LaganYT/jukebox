<html lang="en" ng-app="jukebox" ng-controller="MainCtrl">
	<head>
		<title ng-bind="queue.nowPlaying.streamUrl ? (queue.tracks[queue.nowPlaying.index].name + ' - ' + queue.tracks[queue.nowPlaying.index].artists[0].name) : 'Jukebox Redux'">
			Jukebox Redux
		</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	</head>
	
	<body ng-cloak layout="row">
		
		<audio
			id="song"
			ng-src="{{Player.queue.nowPlaying.streamUrl}}">
		</audio>
		
		<section layout="column" flex>

			<md-toolbar class="md-hue-2" md-whiteframe="3dp">
				<form ng-submit="search(searchText)" class="margin-0">
					<div class="md-toolbar-tools" layout="row" layout-align="space-between center">
						<h2 flex="10" md-truncate>Jukebox</h2>
						
						<p>Latency: {{Player.latency}}</p>
						
						<md-autocomplete
							flex="40"
							ng-disabled="isDisabled"
							md-items="track in loadSuggestions(searchText)"
							md-item-text="track.name"
							md-no-cache="noCache"
							md-selected-item="selectedItem"
							md-search-text="searchText"
							md-selected-item-change="playTrack(track)"
							md-min-length="0"
							md-delay="100"
							md-menu-class="search-suggestion"
							placeholder="Search a song, artist, or album">
							
							<md-item-template ng-click="Player.playTrack(track)">
								<span class="track" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.name}}</span>
								<br/>
								<span class="artist" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.artists[0].name}}</span>
							</md-item-template>
							
							<md-not-found>
								Sorry, we couldn't find <strong>{{searchText}}</strong>
							</md-not-found>
						</md-autocomplete>
						
						<span flex="10"></span>
					</div>
				</form>
		    </md-toolbar>
			
			<md-content layout="row" flex>
				<div flex layout="row" layout-align="space-around stretch">
					<div ng-show="searchResults" flex ng-repeat="section in ['albums', 'artists', 'playlists']" class="scroll-container">
						<md-list flex>
							<md-subheader class="md-no-sticky">{{section | capitalize}}</md-subheader>
							
							<md-list-item class="md-2-line" ng-repeat="item in searchResults[section]" ng-click="setQueue(section, $index, item)">
								<img ng-src="{{item.images[0].url}}" class="md-avatar no-mask" alt="{{todos[0].who}}"/>
								
								<div class="md-list-item-text">
									<h3>{{item.name}}</h3>
									<p>{{item.artists[0].name || item.owner.id}}</p>
								</div>
							</md-list-item>
						</md-list>
					</div>
				</div>
			</md-content>
			
			<playbar></playbar>
		</section>
		
		<md-sidenav
			class="md-sidenav-right"
			md-component-id="right"
			md-is-locked-open="$mdMedia('gt-md')"
			md-whiteframe="10">
			
			<queue></queue>
		</md-sidenav>
		
		<!-- Angular Material requires Angular.js Libraries -->
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

		<!-- Angular Material Library -->
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
		
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script> <!-- Socket.io -->
		<script type="text/javascript" src="https://cdn.rawgit.com/btford/angular-socket-io/master/socket.js"></script> <!-- Angular Socket.io -->
		<script type="text/javascript" src="https://cdn.rawgit.com/jariz/vibrant.js/master/dist/Vibrant.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/maxjoehnk/ngVibrant/fd9c068d/dist/angular-vibrant.js"></script>

		<!-- Your application bootstrap  -->
		<script type="text/javascript">
			/* global angular */
			var app = angular.module('jukebox', ['ngMaterial', 'btford.socket-io', 'ngVibrant']);
			
			app.config(['$mdThemingProvider', function($mdThemingProvider) {
				$mdThemingProvider.theme('light').primaryPalette('blue-grey');
				$mdThemingProvider.theme('dark').primaryPalette('blue-grey').dark();
				
				$mdThemingProvider.setDefaultTheme('dark');
				// $mdThemingProvider.enableBrowserColor({theme: 'dark'});
			}]);

			app.controller('MainCtrl', ['$scope', '$rootScope', '$http', '$location', '$mdMenu', '$mdDialog', '$mdToast', 'Socket', 'Player',
				function($scope, $rootScope, $http, $location, $mdMenu, $mdDialog, $mdToast, Socket, Player) {
					
				$scope.$location = $location;
				$scope.$mdMenu = $mdMenu;
				$scope.Player = Player;
				
				$scope.setQueue = function(dataType, i, source) {
					Socket.emit('queue:set', {
						source: source,
						nowPlaying: {
							index: i,
							progress: 0
						}
					});
				};
				
				$scope.openLyrics = function(event) {
					Socket.emit('lyrics:open', {event: event});
					
					var track = Player.queue.tracks[Player.queue.nowPlaying.index];
					$http.get('/api/tracks/lyrics?track_id='+ track.id).then(function(response) {
						$mdDialog.show({
							parent: angular.element(document.body),
							targetEvent: event,
							templateUrl: '/views/lyrics/lyrics.html',
							locals: {
								
							},
							controller: ['$scope', function($scope) {
								$scope.track = response.data;
							}],
							clickOutsideToClose: true
						});
					});
				};
				
				$scope.search = function(query, limit, offset) {
					$http({
						url: '/api/search',
						method: 'GET',
						params: {
							q: query,
							limit: limit,
							offset: offset
						}
					}).then(function(response) {
						$scope.searchResults = {
							albums: response.data.albums.items,
							artists: response.data.artists.items,
							playlists: response.data.playlists.items
						};
					});
				};
				
				$scope.loadSuggestions = function(query) {
					return $http.get('/api/tracks/search?q='+ query)
						.then(function(response) {
							return response.data.body.tracks.items;
						});
				};
			}]);
		</script>
		
		<script type="text/javascript" src="components/player/playbar/playbar.directive.js"></script>
		<script type="text/javascript" src="components/player/seekbar/seekbar.directive.js"></script>
		<script type="text/javascript" src="components/queue/queue.directive.js"></script>
		
		<script type="text/javascript" src="components/socket/socket.factory.js"></script>
		
		<script type="text/javascript" src="components/player/player.service.js"></script>
		
		<script type="text/javascript" src="filters/capitalize.filter.js"></script>
		<script type="text/javascript" src="filters/seconds-time.filter.js"></script>
		
	</body>
	</html>