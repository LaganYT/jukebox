<html lang="en" ng-app="jukebox" ng-controller="MainCtrl">
<head>
	<title ng-bind="queue.nowPlaying.streamUrl ? (queue.tracks[queue.nowPlaying.index].name + ' - ' + queue.tracks[queue.nowPlaying.index].artists[0].name) : 'Jukebox Redux'">
		Jukebox Redux
	</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		.track {
			margin: 5px;
		}
		.track-desc {
			padding-left: 10px;
			padding-top: 12px;
		}
		.track-desc p {
			margin: 0; padding: 0;
		}
		
		.playerBar {
			width: 100%;
		}
		.playerBar > md-card {
			margin-bottom: 0;
		}
		
		.autocomplete-custom-template .track, .autocomplete-custom-template .artist {
			padding: 0;
			margin: 0;
		}
		
		.margin-0 {
			margin: 0 !important;
		}
		
		.padding-sides {
			padding: 0px 16px;
		}
		
		.md-avatar.no-mask {
			border-radius: 0 !important;
		}
		
		.md-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
		}
		.md-avatar.large {
			width: 60px;
			height: 60px;
		}
		
		.scroll-container {
			overflow-y: scroll;
		}
		
	</style>
</head>
<body ng-cloak layout="column" layout-align="space-between stretch" style="height: 100vh;">

	<md-toolbar class="md-hue-2" md-whiteframe="3dp">
		<form ng-submit="search(searchText)" class="margin-0">
			<div class="md-toolbar-tools" layout="row" layout-align="space-between center">
				<h2 flex="10" md-truncate>Jukebox</h2>
				
				<md-autocomplete
					flex="40"
					ng-disabled="isDisabled"
					md-items="track in loadSuggestions(searchText)"
					md-item-text="track.name"
					md-no-cache="noCache"
					md-selected-item="selectedItem"
					md-search-text="searchText"
					md-selected-item-change="playTrack(track)"
					md-min-length="0"
					md-delay="100"
					md-menu-class="search-suggestion"
					placeholder="Search a song, artist, or album">
					
					<md-item-template ng-click="playTrack(track)">
						<span class="track" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.name}}</span>
						<br/>
						<span class="artist" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.artists[0].name}}</span>
					</md-item-template>
					
					<md-not-found>
						Sorry, we couldn't find <strong>{{searchText}}</strong>
					</md-not-found>
				</md-autocomplete>
				
				<span flex="10"></span>
			</div>
		</form>
    </md-toolbar>
	
	<div layout="row" flex>
		<span ng-show="!searchResults" flex></span>
		
		<div layout="row" layout-align="space-around stretch" flex ng-show="searchResults">
			<div flex ng-repeat="section in ['albums', 'playlists']"  class="scroll-container">
				<md-list flex>
					<md-subheader class="md-no-sticky">{{section | capitalize}}</md-subheader>
					
					<md-list-item class="md-2-line" ng-repeat="item in searchResults[section]" ng-click="createNewQueue(section, $index, item)">
						<img ng-src="{{item.images[0].url}}" class="md-avatar no-mask" alt="{{todos[0].who}}"/>
						
						<div class="md-list-item-text">
							<h3>{{item.name}}</h3>
							<p>{{item.artists[0].name || item.owner.id}}</p>
						</div>
					</md-list-item>
				</md-list>
			</div>
		</div>
		
		<div flex="30" ng-show="Player.queue.source" class="padding-sides scroll-container" md-whiteframe="4dp" style="z-index: 1;">
			<p class="md-body-2">Now Playing</p>
			
			<div layout="row">
				<img ng-src="{{Player.queue.source.images[0].url}}" class="md-avatar large no-mask"/>
				
				<div layout="column" style="margin: 5px 15px;">
					<p class="md-title margin-0">{{Player.queue.source.name}}</p>
					<p class="md-subhead margin-0">{{Player.queue.source.artists[0].name || Player.queue.source.owner.id}}</p>
				</div>
			</div>
			
			<md-list>
				<md-list-item class="md-2-line" ng-repeat="track in Player.queue.tracks" ng-click="playTrackFromIndex($index)">
					<img
						ng-src="{{Player.queue.nowPlaying.index == $index ? 'http://i.imgur.com/zKQ3N8e.gif' : (track.album.images[0].url || Player.queue.source.images[0].url)}}"
						class="md-avatar no-mask"
						alt="{{track.name}}"/>
					
					<div class="md-list-item-text">
						<h3>{{track.name}}</h3>
						<p>{{track.artists[0].name}}</p>
					</div>
			</md-list>			
		</div>
	</div>
	
	<div class="playerBar" layout="row" layout-align="center end" style="z-index: 2" ng-show="Player.queue.nowPlaying.streamUrl">
		<md-card flex="70" layout="row">
			<audio
				id="song"
				controls
				ng-src="{{Player.queue.nowPlaying.streamUrl}}"
				style="width: 100% !important;">
			</audio>
			
			<md-button class="md-icon-button" ng-click="openLyrics($event)">
				<md-icon class="material-icons">music_note</md-icon>
			</md-button>
		</md-card>
	</div>
	
	<!-- Angular Material requires Angular.js Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

	<!-- Angular Material Library -->
	<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script> <!-- Socket.io -->
	<script src="https://cdn.rawgit.com/btford/angular-socket-io/master/socket.js"></script> <!-- Angular Socket.io -->
	<script src="https://cdn.rawgit.com/danielstern/ngAudio/master/app/angular.audio.js"></script>

	<!-- Your application bootstrap  -->
	<script type="text/javascript">
		/* global angular */
		var app = angular.module('jukebox', ['ngMaterial', 'ngAudio', 'btford.socket-io']);
		
		app.factory('Socket', ['socketFactory', function(socketFactory) {
			return socketFactory();
		}]);
		
		app.service('Player', ['$rootScope', 'Socket', '$http', function($rootScope, Socket, $http) {
			var Player = this;
			
			this.el = document.getElementById('song');
			
			this.queue = {
				nowPlaying: {
					index: 0
				}
			};
			
			this.createNewQueue = function(dataType, i, item, source) {
				var promise;
				
				switch (dataType) {
					case 'albums':
						promise = $http.get('/api/albums/'+item.id+'/tracks');
						break;
					case 'playlists':
						promise = $http.get('/api/users/'+item.owner.id+'/playlists/'+item.id+'/tracks');
						break;
				}
				
				promise.then(function(response) {
					Player.queue.source = source;
					Player.queue.tracks = (dataType == 'playlists' ? response.data.items.map(o => o.track) : response.data.items);
					Player.queue.nowPlaying.index = 0;
					Player.playTrack(Player.queue.tracks[0]);
				});
			};
			
			this.playTrack = function(track) {
				var artistName = track.artists[0].name,
					trackName = track.name;
				
				Player.queue.nowPlaying.streamUrl = '/api/tracks/mp3?artist='+artistName+'&track='+trackName;
			};
			
			this.playTrackFromIndex = function(index) {
				Player.queue.nowPlaying.index = index;
				Player.playTrack(Player.queue.tracks[index]);
			};
			
			this.skipTrack = function() {
				Player.queue.nowPlaying.index++;
			    Player.playTrackFromIndex(Player.queue.nowPlaying.index);
			};
			
			this.el.addEventListener('play', function() { Socket.emit('playback:play'); });
			
			this.el.addEventListener('pause', function() { Socket.emit('playback:pause'); });
			
			this.el.addEventListener('onended', function() { Socket.emit('track:ended'); });
			
			this.el.addEventListener('oncanplay', function() { Socket.emit('track:canplay'); });
			
			Socket.on('queue:create', function(data) {
				console.log(data);
				Player.createNewQueue(data.dataType, data.i, data.item, data.source);
			});
			
			Socket.on('track:play', function(data) {
				Player.playTrack(data.track);
			});
			
			Socket.on('track:play.index', function(data) {
				Player.playTrackFromIndex(data.index);
			});
			
			Socket.on('playback:play', function() {
				Player.el.play();
			});
			
			Socket.on('playback:pause', function() {
				Player.el.pause();
			});
			
			Socket.on('playback:ended', function() {
				Player.el.skipTrack();
			});
		}]);

		app.controller('MainCtrl', ['$scope', '$http', 'ngAudio', '$location', '$mdMenu', '$mdDialog', 'Socket', 'Player',
			function($scope, $http, ngAudio, $location, $mdMenu, $mdDialog, Socket, Player) {
				
			$scope.$location = $location;
			$scope.$mdMenu = $mdMenu;
			$scope.Player = Player;
			
			$scope.createNewQueue = function(dataType, i, item) {
				var source = $scope.searchResults[dataType][i];
				
				Socket.emit('queue:create', {dataType: dataType, i: i, item: item, source: source});
				Player.createNewQueue(dataType, i, item, source);
			};
			
			$scope.playTrack = function(track) {
				Socket.emit('track:play', {track: track});
				Player.playTrack(track);
			};
			
			$scope.playTrackFromIndex = function(index) {
				Socket.emit('track:play.index', {index: index});
				
				Player.playTrackFromIndex(index);
			};
			
			$scope.skipTrack = function() {
				Socket.emit('track:ended');
				Player.skipTrack();
			};
			
			$scope.openLyrics = function(event) {
				Socket.emit('lyrics:open', {event: event});
				
				var track = Player.queue.tracks[Player.queue.nowPlaying.index];
				$http.get('/api/tracks/lyrics?track_id='+ track.id).then(function(response) {
					$mdDialog.show({
						parent: angular.element(document.body),
						targetEvent: event,
						template:
						   `<h3>Lyrics:</h3>
							<p style="white-space: pre;">
								{{track.lyrics}}
							</p>
							<p>
								Lyrics from
								<a href="{{track.url}}" target="_blank">MetroLyrics</a>
							</p>`,
						locals: {
							
						},
						controller: ['$scope', function($scope) {
							$scope.track = response.data;
						}],
						clickOutsideToClose: true
					});
				});
			};
			
			$scope.search = function(query, limit, offset) {
				$http({
					url: '/api/search',
					method: 'GET',
					params: {
						q: query,
						limit: limit,
						offset: offset
					}
				}).then(function(response) {
					$scope.searchResults = {
						albums: response.data.albums.items,
						artists: response.data.artists.items,
						playlists: response.data.playlists.items
					};
				});
			};
			
			$scope.loadSuggestions = function(query) {
				return $http.get('/api/tracks/search?q='+ query)
					.then(function(response) {
						return response.data.body.tracks.items;
					});
			};
		}]);
		
		app.filter('capitalize', function() {
			return function(token) {
				return token.charAt(0).toUpperCase() + token.slice(1);
			};
		});
	</script>
	
</body>
</html>