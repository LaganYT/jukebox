<html lang="en" >
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
	<style>
		.track {
			margin: 5px;
		}
		.track-desc {
			padding-left: 10px;
			padding-top: 12px;
		}
		.track-desc p {
			margin: 0; padding: 0;
		}
		
	</style>
</head>
<body ng-app="jukebox" ng-controller="MainCtrl" ng-cloak>
	
	<form ng-submit="search(search.query)">
		<md-input-container>
			<label>Search a song</label>
			<input ng-model="search.query">
		</md-input-container>

		<md-button class="md-raised md-primary" type="submit">Search</md-button>
	</form>

	<audio id="song" ng-show="trackUrl" controls autoplay ng-src="{{trackUrl}}"></audio>
	
	{{trackUrl}}

	<div ng-if="tracks && tracks.length != 0">
		<div ng-repeat="track in tracks" class="track" layout="row" ng-click="playTrack($index)">
			<img ng-src="{{track.album.images[2].url}}"/>

			<div layout="column" class="track-desc">
				<strong>{{track.name}}</strong>
				<p>{{track.artists[0].name}}</p>
			</div>
		</div>
	</div>
	
	<!-- Angular Material requires Angular.js Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

	<!-- Angular Material Library -->
	<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
	
	<script src="https://cdn.rawgit.com/danielstern/ngAudio/master/app/angular.audio.js"></script>

	<!-- Your application bootstrap  -->
	<script type="text/javascript">
		var app = angular.module('jukebox', ['ngMaterial', 'ngAudio']);

		app.controller('MainCtrl', ['$scope', '$http', 'ngAudio', function($scope, $http, ngAudio) {
			var currentSong = null;
			
			document.getElementById('song').onended = function() {
			    currentSong++;
			    $scope.playTrack(currentSong);
			};
			
			$scope.search = function(query) {
				$http.get('/api/tracks/search?q='+query).then(function(response) {
					console.log(response.data.body.tracks.items);
					$scope.tracks = response.data.body.tracks.items;
				}, function(err) {
					console.log(err);
				});
			};

			$scope.playTrack = function(index) {
				console.log('asdf');
				currentSong = index;
				var track = $scope.tracks[index],
					artist = track.artists[0].name,
					trackName = track.name;
				
				$scope.trackUrl = '/api/tracks/mp3?artist='+artist+'&track='+trackName;
				$scope.$apply();
				console.log(artist, trackName, $scope.trackUrl);
			};
		}]);
	</script>
	
</body>
</html>