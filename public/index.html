	<html lang="en" ng-app="jukebox" ng-controller="MainCtrl">
	<head>
		<title ng-bind="queue.nowPlaying.streamUrl ? (queue.tracks[queue.nowPlaying.index].name + ' - ' + queue.tracks[queue.nowPlaying.index].artists[0].name) : 'Jukebox Redux'">
			Jukebox Redux
		</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<style>
			.track {
				margin: 5px;
			}
			.track-desc {
				padding-left: 10px;
				padding-top: 12px;
			}
			.track-desc p {
				margin: 0; padding: 0;
			}
			
			.playerBar {
				width: 100%;
			}
			.playerBar > md-card {
				margin-bottom: 0;
			}
			
			.autocomplete-custom-template .track, .autocomplete-custom-template .artist {
				padding: 0;
				margin: 0;
			}
			
			.margin-0 {
				margin: 0 !important;
			}
			
			.padding-sides {
				padding: 0px 16px;
			}
			
			.md-avatar.no-mask {
				border-radius: 0 !important;
			}
			
			.md-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
			}
			.md-avatar.large {
				width: 60px;
				height: 60px;
			}
			
			.scroll-container {
				overflow-y: scroll;
			}
			
		</style>
	</head>
	<body ng-cloak layout="column" layout-align="space-between stretch" style="height: 100vh;">

		<md-toolbar class="md-hue-2" md-whiteframe="3dp">
			<form ng-submit="search(searchText)" class="margin-0">
				<div class="md-toolbar-tools" layout="row" layout-align="space-between center">
					<h2 flex="10" md-truncate>Jukebox</h2>
					
					<p>Latency: {{Player.latency}}</p>
					
					<md-autocomplete
						flex="40"
						ng-disabled="isDisabled"
						md-items="track in loadSuggestions(searchText)"
						md-item-text="track.name"
						md-no-cache="noCache"
						md-selected-item="selectedItem"
						md-search-text="searchText"
						md-selected-item-change="playTrack(track)"
						md-min-length="0"
						md-delay="100"
						md-menu-class="search-suggestion"
						placeholder="Search a song, artist, or album">
						
						<md-item-template ng-click="Player.playTrack(track)">
							<span class="track" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.name}}</span>
							<br/>
							<span class="artist" md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{track.artists[0].name}}</span>
						</md-item-template>
						
						<md-not-found>
							Sorry, we couldn't find <strong>{{searchText}}</strong>
						</md-not-found>
					</md-autocomplete>
					
					<span flex="10"></span>
				</div>
			</form>
	    </md-toolbar>
		
		<div layout="row" flex>
			<md-button class="md-raised" ng-click="Player.plause()">{{Player.el.paused ? 'Play' : 'Pause'}}</md-button>
			
			<div layout="row" layout-align="space-around stretch" flex ng-show="searchResults">
				<div flex ng-repeat="section in ['albums', 'artists', 'playlists']"  class="scroll-container">
					<md-list flex>
						<md-subheader class="md-no-sticky">{{section | capitalize}}</md-subheader>
						
						<md-list-item class="md-2-line" ng-repeat="item in searchResults[section]" ng-click="setQueue(section, $index, item)">
							<img ng-src="{{item.images[0].url}}" class="md-avatar no-mask" alt="{{todos[0].who}}"/>
							
							<div class="md-list-item-text">
								<h3>{{item.name}}</h3>
								<p>{{item.artists[0].name || item.owner.id}}</p>
							</div>
						</md-list-item>
					</md-list>
				</div>
			</div>
			
			<div flex="30" ng-show="Player.queue.source" class="padding-sides scroll-container" md-whiteframe="4dp" style="z-index: 1;">
				<p class="md-body-2">Now Playing</p>
				
				<div layout="row">
					<img ng-src="{{Player.queue.source.images[0].url}}" class="md-avatar large no-mask"/>
					
					<div layout="column" style="margin: 5px 15px;">
						<p class="md-title margin-0">{{Player.queue.source.name}}</p>
						<p class="md-subhead margin-0">{{Player.queue.source.artists[0].name || Player.queue.source.owner.id}}</p>
					</div>
				</div>
				
				<md-list>
					<md-list-item class="md-2-line" ng-repeat="track in Player.queue.tracks" ng-click="Player.playTrackFromIndex($index)">
						<img
							ng-src="{{Player.queue.nowPlaying.index == $index ? 'http://i.imgur.com/zKQ3N8e.gif' : (track.album.images[0].url || Player.queue.source.images[0].url)}}"
							class="md-avatar no-mask"
							alt="{{track.name}}"/>
						
						<div class="md-list-item-text">
							<h3>{{track.name}}</h3>
							<p>{{track.artists[0].name}}</p>
						</div>
				</md-list>			
			</div>
		</div>
		
		<div class="playerBar" layout="row" layout-align="center end" style="z-index: 2" ng-show="Player.queue.nowPlaying.streamUrl">
			<md-card flex="100" flex-gt-sm="70" layout="row">
				<audio
					id="song"
					controls
					ng-src="{{Player.queue.nowPlaying.streamUrl}}"
					style="width: 100% !important;">
				</audio>
				
				<md-button class="md-icon-button" ng-click="openLyrics($event)">
					<md-icon class="material-icons">music_note</md-icon>
				</md-button>
			</md-card>
		</div>
		
		<!-- Angular Material requires Angular.js Libraries -->
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

		<!-- Angular Material Library -->
		<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script> <!-- Socket.io -->
		<script src="https://cdn.rawgit.com/btford/angular-socket-io/master/socket.js"></script> <!-- Angular Socket.io -->
		<script src="https://cdn.rawgit.com/danielstern/ngAudio/master/app/angular.audio.js"></script>

		<!-- Your application bootstrap  -->
		<script type="text/javascript">
			/* global angular */
			var app = angular.module('jukebox', ['ngMaterial', 'ngAudio', 'btford.socket-io']);
			
			app.factory('Socket', ['socketFactory', function(socketFactory) {
				return socketFactory();
			}]);
			
			app.service('Player', ['$rootScope', 'Socket', '$http', '$mdToast', function($rootScope, Socket, $http, $mdToast) {
				var Player = this;
				
				this.el = document.getElementById('song');
				
				this.queue = {
					nowPlaying: {
						index: 0
					}
				};
				
				this.latency = 100;
				this.maxLatency = 250;
				
				var pingTime, pongTime, latency, showedSlowConnectionToast = false;
				
				// Ping each client to test connection speed
			    setInterval(function() {
			        pingTime = new Date();
			        Socket.emit('connection:ping');
			    }, (5 * 1000));
			    
				// Recieve pong and save response time
				Socket.on('connection:pong', function() {
		            pongTime = new Date();
		        	Player.latency = latency = (pongTime - pingTime) / 2;
		            
		            if (latency > 1000 && !showedSlowConnectionToast) {
						$mdToast.show($mdToast.simple().textContent('Connection too slow for synced music'));
						showedSlowConnectionToast = true;
		            }
		        });
				
				this.setQueue = function(newQueue) {
					var promise;
					this.queue = Object.assign(this.queue, newQueue);
					console.log(this.queue);
					
					switch (newQueue.source.type) {
						case 'album':
							promise = $http.get('/api/albums/'+newQueue.source.id+'/tracks');
							break;
						case 'playlist':
							promise = $http.get('/api/users/'+newQueue.source.owner.id+'/playlists/'+newQueue.source.id+'/tracks');
							break;
						case 'artist':
							promise = $http.get('/api/artists/'+newQueue.source.id+'/top-tracks');
							break;
						default:
							console.log('no case selected');
					}
					
					promise.then(function(response) {
						console.log(response);
						Player.queue = newQueue;
						switch (newQueue.source.type) {
							case 'playlist':
								Player.queue.tracks = response.data.items.map(o => o.track);
								break;
							case 'album':
								Player.queue.tracks = response.data.items;
							case 'artist':
							default:
								Player.queue.tracks = response.data.tracks;
								break;
						}
						Player.playTrack(Player.queue.tracks[0]);
					});
				};
				
				Socket.on('queue:set', function(newQueue) {
					Player.setQueue(newQueue);
				});
				
				this.plause = function() {
					Socket.emit(Player.el.paused ? 'playback:play' : 'playback:pause');
				};
				
				Socket.on('playback:play', function() {
					setTimeout(function() {
						Player.el.play();
					}, (Player.maxLatency - Player.latency));
				});
				
				Socket.on('playback:pause', function() {
					setTimeout(function() {
						Player.el.pause();
					}, (Player.maxLatency - Player.latency));
				});
				
				
				this.playTrack = function(track) {
					// Infinite recursion on multiclient playback -- fix this!
					Socket.emit('track:play', {track: track});
					
					var artistName = track.artists[0].name,
						trackName = track.name;
					
					Player.queue.nowPlaying.streamUrl = '/api/tracks/mp3?artist='+artistName+'&track='+trackName;
				};
				
				Socket.on('track:play', function(data) {
					Player.playTrack(data.track);
				});
				
				
				this.playTrackFromIndex = function(index) {
					Socket.emit('track:play.index', {index: index});
					
					Player.queue.nowPlaying.index = index;
					Player.playTrack(Player.queue.tracks[index]);
				};
				
				Socket.on('track:play.index', function(data) {
					Player.playTrackFromIndex(data.index);
				});
				
				
				this.skipTrack = function() {
					Socket.emit('track:ended');
					
					Player.queue.nowPlaying.index++;
				    Player.playTrackFromIndex(Player.queue.nowPlaying.index);
				};
				
				Player.el.addEventListener('canplay', function() {
					Socket.emit('playback:canplay');
				})
				
				Socket.on('playback:ended', function() {
					Player.el.skipTrack();
				});
			}]);

			app.controller('MainCtrl', ['$scope', '$rootScope', '$http', 'ngAudio', '$location', '$mdMenu', '$mdDialog', '$mdToast', 'Socket', 'Player',
				function($scope, $rootScope, $http, ngAudio, $location, $mdMenu, $mdDialog, $mdToast, Socket, Player) {
					
				$scope.$location = $location;
				$scope.$mdMenu = $mdMenu;
				$scope.Player = Player;
				
				$scope.setQueue = function(dataType, i, source) {
					Socket.emit('queue:set', {
						source: source,
						nowPlaying: {
							index: i,
							progress: 0
						}
					});
				};
				
				$scope.openLyrics = function(event) {
					Socket.emit('lyrics:open', {event: event});
					
					var track = Player.queue.tracks[Player.queue.nowPlaying.index];
					$http.get('/api/tracks/lyrics?track_id='+ track.id).then(function(response) {
						$mdDialog.show({
							parent: angular.element(document.body),
							targetEvent: event,
							template:
							   `<h3>Lyrics:</h3>
								<p style="white-space: pre;">
									{{track.lyrics}}
								</p>
								<p>
									Lyrics from
									<a href="{{track.url}}" target="_blank">MetroLyrics</a>
								</p>`,
							locals: {
								
							},
							controller: ['$scope', function($scope) {
								$scope.track = response.data;
							}],
							clickOutsideToClose: true
						});
					});
				};
				
				$scope.search = function(query, limit, offset) {
					$http({
						url: '/api/search',
						method: 'GET',
						params: {
							q: query,
							limit: limit,
							offset: offset
						}
					}).then(function(response) {
						$scope.searchResults = {
							albums: response.data.albums.items,
							artists: response.data.artists.items,
							playlists: response.data.playlists.items
						};
					});
				};
				
				$scope.loadSuggestions = function(query) {
					return $http.get('/api/tracks/search?q='+ query)
						.then(function(response) {
							return response.data.body.tracks.items;
						});
				};
			}]);
			
			app.filter('capitalize', function() {
				return function(token) {
					return token.charAt(0).toUpperCase() + token.slice(1);
				};
			});
		</script>
		
	</body>
	</html>